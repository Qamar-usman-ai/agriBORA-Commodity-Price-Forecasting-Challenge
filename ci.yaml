name: CI for Streamlit App

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install streamlit pandas
    
    - name: Verify files exist
      run: |
        echo "Checking required files..."
        ls -la
        echo ""
        echo "Required files:"
        echo "1. forecasting.py"
        echo "2. agriBORA_maize_prices.csv"
        echo "3. agriBORA_maize_prices_weeks_46_to_51.csv"
        echo ""
        
        if [ -f "forecasting.py" ]; then
          echo "✅ forecasting.py exists"
        else
          echo "❌ forecasting.py missing"
          exit 1
        fi
        
        if [ -f "agriBORA_maize_prices.csv" ]; then
          echo "✅ agriBORA_maize_prices.csv exists"
        else
          echo "❌ agriBORA_maize_prices.csv missing"
          exit 1
        fi
        
        if [ -f "agriBORA_maize_prices_weeks_46_to_51.csv" ]; then
          echo "✅ agriBORA_maize_prices_weeks_46_to_51.csv exists"
        else
          echo "❌ agriBORA_maize_prices_weeks_46_to_51.csv missing"
          exit 1
        fi
    
    - name: Test imports
      run: |
        python -c "
        print('Testing imports...')
        try:
            import streamlit
            import pandas as pd
            print('✅ All imports successful')
        except Exception as e:
            print(f'❌ Import error: {e}')
            exit(1)
        "
    
    - name: Test data loading
      run: |
        python -c "
        print('Testing data loading...')
        try:
            import pandas as pd
            
            # Load data
            df1 = pd.read_csv('agriBORA_maize_prices.csv')
            df2 = pd.read_csv('agriBORA_maize_prices_weeks_46_to_51.csv')
            
            print(f'✅ Data loaded successfully')
            print(f'   agriBORA_maize_prices.csv: {df1.shape[0]} rows x {df1.shape[1]} cols')
            print(f'   agriBORA_maize_prices_weeks_46_to_51.csv: {df2.shape[0]} rows x {df2.shape[1]} cols')
            
            # Check columns
            required = ['Date', 'County', 'WholeSale']
            for col in required:
                if col not in df1.columns:
                    print(f'❌ Missing column {col} in agriBORA_maize_prices.csv')
                    exit(1)
                if col not in df2.columns:
                    print(f'❌ Missing column {col} in agriBORA_maize_prices_weeks_46_to_51.csv')
                    exit(1)
            
            print('✅ All required columns present')
            
        except Exception as e:
            print(f'❌ Data loading error: {e}')
            exit(1)
        "
